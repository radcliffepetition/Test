<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Review</title>

<!-- EMAILJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body {
    background: #111;
    color: white;
    font-family: 'Orbitron', sans-serif;
    text-align: center;
    padding: 40px;
}

h1 { margin-bottom: 30px; }

.submission-block {
    background: #222;
    padding: 20px;
    margin: 20px auto;
    max-width: 700px;
    border-radius: 14px;
    text-align: left;
    box-shadow: 0 0 15px rgba(0,255,255,0.3);
}

button {
    padding: 12px 20px;
    margin: 8px 6px 0 0;
    font-size: 1rem;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: 0.25s;
}

button:hover { transform: translateY(-2px); }

.approve {
    background: #00ff88;
    color: black;
    font-weight: 600;
}

.deny {
    background: #ff5555;
    color: black;
    font-weight: 600;
}
</style>
</head>
<body>

<h1>Quiz Submissions</h1>
<div id="submissionsContainer">Loading submissions...</div>

<script>
// ================= EMAILJS INIT =================
emailjs.init("rK3VxKe5ekdl_Tg0u"); // <-- REPLACE
</script>

<script type="module">
// ================= FIREBASE IMPORTS =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
    getFirestore,
    collection,
    getDocs,
    query,
    where,
    doc,
    updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ================= FIREBASE CONFIG =================
const firebaseConfig = {
  apiKey: "AIzaSyD4bDMS9X_HqSDa-2qVTZKNNsXVVA1A1A4",
  authDomain: "gggg-2095f.firebaseapp.com",
  projectId: "gggg-2095f",
  storageBucket: "gggg-2095f.firebasestorage.app",
  messagingSenderId: "1047765928516",
  appId: "1:1047765928516:web:6fe090e104b7bf735a8a11"
};

// ================= INIT FIREBASE =================
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const submissionsContainer = document.getElementById("submissionsContainer");

// ================= LOAD SUBMISSIONS =================
async function loadSubmissions() {
    submissionsContainer.innerHTML = "Loading submissions...";

    const q = query(
        collection(db, "quizSubmissions"),
        where("approved", "==", false)
    );

    const snapshot = await getDocs(q);
    submissionsContainer.innerHTML = "";

    if (snapshot.empty) {
        submissionsContainer.innerHTML = "<p>No pending submissions.</p>";
        return;
    }

    snapshot.forEach((docSnap) => {
        const data = docSnap.data();

        const block = document.createElement("div");
        block.className = "submission-block";

        block.innerHTML = `
            <h3>Email: ${data.email || "No email"}</h3>
        `;

        data.responses.forEach((r, i) => {
            block.innerHTML += `
                <p><strong>Q${i+1}:</strong> ${r.question}<br>
                <em>${r.answer}</em></p>
            `;
        });

        // ===== APPROVE BUTTON =====
        const approveBtn = document.createElement("button");
        approveBtn.className = "approve";
        approveBtn.textContent = "Approve";

        approveBtn.onclick = async () => {
            if (!data.email) {
                alert("No email found for this submission.");
                return;
            }

            try {
                // SEND EMAIL
                await emailjs.send(
                    "service_h1n8cxl",   // <-- REPLACE
                    "template_gx4hm3f",  // <-- REPLACE
                    {
                        to_email: data.email
                    }
                );

                // UPDATE FIRESTORE
                await updateDoc(doc(db, "quizSubmissions", docSnap.id), {
                    approved: true
                });

                block.remove(); // remove from page instantly

            } catch (err) {
                alert("Error sending email.");
                console.error(err);
            }
        };

        // ===== DENY BUTTON =====
        const denyBtn = document.createElement("button");
        denyBtn.className = "deny";
        denyBtn.textContent = "Deny";

        denyBtn.onclick = async () => {
            await updateDoc(doc(db, "quizSubmissions", docSnap.id), {
                approved: true
            });
            block.remove();
        };

        block.appendChild(approveBtn);
        block.appendChild(denyBtn);
        submissionsContainer.appendChild(block);
    });
}

// LOAD ON PAGE OPEN
loadSubmissions();
</script>

</body>
</html>
